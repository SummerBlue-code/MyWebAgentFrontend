<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Chat Interface</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
    --primary-color: #2d8cf0;
    --blur-intensity: 5px;
}

body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    overflow: hidden;
    position: relative;
    height: 100vh;
}

/* 背景 */
.background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('background-image.jpg');
    background-size: cover;
    background-position: center;
    z-index: -1;
    transition: filter 0.3s ease;
}

/* 搜索栏容器 */
.search-container {
    position: relative;
    top: 50%;
    left: 50%;
    width: 40%;
    transform: translate(-50%, -50%);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.input-group{
    position: relative;
    width: 95.4%;
}

/* 搜索输入框 */
#search-bar {
    width: 100%;
    padding: 18px 25px;
    border: none;
    border-radius: 30px;
    font-size: 16px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}
/* 搜索按钮 */
#search-btn {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translate(50%,-50%);
    padding: 10px 24px;
    border: none;
    border-radius: 25px;
    background: #4f46e5;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
}

/* 动态聊天区 */
.chat-container {
    display: none;
    height: calc(100vh - 130px);
    overflow-y: auto;
    padding: 20px;
}

.chat-active .search-container {
    top: 2%;
    transform: translateX(-40%);
    width: calc(75%);
}

/* 历史聊天记录按钮 */
#history-button {
    position: absolute;
    top: 50%;
    /*left: 10px;*/
    transform: translateY(-50%);
    padding: 10px 7px 7px 7px;
    background-color: #007BFF;
    color: white;
    border: none;
    border-radius: 0px 5px 5px 0;
    cursor: pointer;
    writing-mode: vertical-rl;
    letter-spacing: 3px;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* 历史聊天记录面板 */
.history-panel {
    position: absolute;
    top: 0;
    left: 0;
    width: 250px;
    height: 100%;
    background-color: white;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
}

/* 面板按钮 */
.panel-buttons {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    background-color: #f0f0f0;
}

.panel-buttons button {
    padding: 5px 10px;
    border: none;
    background-color: #007BFF;
    color: white;
    border-radius: 5px;
    cursor: pointer;
}

/* 聊天历史记录项 */
.chat-history {
    padding: 10px;
}

.chat-item {
    padding: 10px;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
}

/* 设置按钮 */
#settings-button {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 10px;
    background-color: #007BFF;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    z-index: 1;
}

/* 消息气泡 */
.message {
    max-width: 70%;
    margin: 15px 0;
    padding: 12px 18px;
    border-radius: 20px;
    position: relative;
    animation: fadeIn 0.3s ease;
}
.user-message {
    background: #2b5278;
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 5px;
}
.ai-message {
    background: #333;
    color: #f0f0f0;
    border-bottom-left-radius: 5px;
}

/* 状态指示器容器 */
.status-indicator {
  position: absolute;

  bottom: 8px;
  display: flex;
  align-items: center;
  gap: 3px;
}

.user-status-indicator {
    left: -28px;
}

.ai-status-indicator {
    right: -28px;
}

/* 加载动画 */
.loading {
  width: 12px;
  height: 12px;
  border: 2px solid #ffffff66;
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* 状态图标 */
.status-indicator span {
  color: #ffffff99;
  font-size: 12px;
  display: none;
}

.sent { color: #4CAF50; }
.read { color: #2196F3; }

/* 根据状态显示对应图标 */
.message.sending  .loading { display: block; }
.message.sent  .sent { display: block; }
.message.read  .read { display: block; }

/* 动态关闭按钮容器 */
.close-handler {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 10;
}
/* 现代关闭按钮设计 */
.close-button {
    width: 28px;
    height: 28px;
    background: #f44336;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
}
.close-button:hover {
    transform: rotate(90deg) scale(1.1);
    background: #d32f2f;
}
/* 关闭图标 */
.close-icon {
    stroke: white;
    stroke-width: 2;
    width: 14px;
    height: 14px;
}
/* 增强型面板样式 */
.settings-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: min(90%, 400px);
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    z-index: 100;
    padding: 20px;
}
.settings-panel.active  {
    opacity: 1;
    visibility: visible;
}
/* 半透明遮罩层 */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(3px);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
    z-index: 90;
}
.overlay.active  {
    opacity: 1;
    visibility: visible;
}
        .MCP-setting-head {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .MCP-control{
            margin: 12px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .MCP-server-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .function-list {
            margin: 20px 0;
            border: 1px solid #eee;
            background: #fff;
            max-height: 60vh;
            overflow-y: auto;
            display: flex;
        }

        .function-item {
            padding: 12px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            transition: background 0.2s;
        }

        .parameter-list {
            margin-top: 8px;
            background: #fff;
            padding-left: 15px;
            color: #666;
        }
    </style>
</head>

<body>
    <!-- 背景 -->
    <div class="background"></div>

    <!-- 遮罩层 -->
    <div class="overlay" id="overlay"></div>

    <!-- 设置面板悬浮窗容器 -->
    <div class="settings-panel" id="settings-panel">
        <div class="close-handler">
            <button class="close-button" id="close-button">
                <svg class="close-icon" viewBox="0 0 24 24">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="panel-content">
            <h2 id="global-settings">全局设置</h2>
            <div class="setting-container">
                <div class="MCP-setting" id="MCP-setting">
                    <div class="MCP-setting-head" id="MCP-setting-head">
                        <h3>MCP 服务器管理</h3>
                        <p style="color: #666; font-size: 0.9em">MCP (Method Call Protocol) 服务器类似RPC服务，提供远程函数调用接口</p>
                    </div>
                    <div class="MCP-control">
                        <input type="text" id="serverUrl" placeholder="输入服务器地址 (例：https://example.com:8080)"
                               style="width: 100%; padding: 8px; margin-bottom: 8px;box-sizing: border-box">
                        <button onclick="addServer()" style="background: #4CAF50; color: white; padding: 8px 16px; border: none; border-radius: 4px">
                            添加服务器
                        </button>
                    </div>
                    <!-- 服务器列表 -->
                    <div class="MCP-server-list" id="MCP-server-list">
                        <!-- 动态生成的服务器项 -->
                    </div>
                </div>

            </div>
            <!-- 设置内容区域 -->
        </div>
    </div>

    <!-- 搜索栏 -->
    <div class="search-container">
        <div class="chat-container" id="chatContainer"></div>
        <div class="input-group">
            <input type="text" id="search-bar" placeholder="输入您的问题...">
            <button id="search-btn">搜索</button>
        </div>
    </div>

    <!-- 历史聊天记录按钮 -->
    <button id="history-button">历史记录</button>

    <!-- 历史聊天记录面板 -->
    <div class="history-panel">
        <div class="panel-buttons">
            <button id="new-chat-button">新建对话</button>
            <button id="fix-panel-button">固定面板</button>
        </div>
        <div class="chat-history">
            <div class="chat-item">Chat 1</div>
            <div class="chat-item">Chat 2</div>
            <div class="chat-item">Chat 3</div>
        </div>
    </div>

    <!-- 设置按钮 -->
    <button id="settings-button">设置</button>

    <script>
        let userQuestion = ""
        let serverList = [];
        let GPTFunctions = []
        let selectedFunctions = new Set();
        let chatHistoryList = [];
        let socket = null;

        const searchInput = document.getElementById('search-bar');
        const searchButton = document.getElementById('search-btn');
        const background = document.querySelector('.background');
        const searchContainer = document.querySelector('.search-container');
        const ChatContainer = document.getElementById('chatContainer')
        const historyButton = document.getElementById('history-button');
        const historyPanel = document.querySelector('.history-panel');
        const chatHistory = historyPanel.querySelector('.chat-history');
        const newChatButton = document.getElementById('new-chat-button');


        const fixPanelButton = document.getElementById('fix-panel-button');
        const settingsButton = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const closeButton = document.getElementById('close-button');
        const overlay = document.getElementById('overlay');

        document.addEventListener('DOMContentLoaded',  () => {
          // 特性检测
          if ('WebSocket' in window) {
            Login();
          } else {
            alert('当前浏览器不支持 WebSocket，请使用 Chrome 16+/Firefox 11+');
          }
        });

        async function Login(){
            socket = new WebSocket('ws://localhost:8765');

            socket.onopen  = function(event) {
                console.log(' 连接已建立，当前时间：', new Date().toLocaleString());

                console.log('正在使用user_id:"gg"进行登陆...')
                socket.send(JSON.stringify({
                    "user_id": "gg"
                }))
                console.log('登录成功!')

            };

            socket.onmessage  = function(event) {
                console.log(' 收到消息：', event.data);
                // 可在此处处理实时数据推送（如股票行情、聊天消息等）
                let data = JSON.parse(event.data);
                if (data.type === 'server_answer'){
                    addMessage(data["answer"],"ai")
                }
                if (data.type === 'server_answer_end'){
                    console.log("正在执行对话结束")
                    addMessage("","ai_end")
                }
                if (data.type === 'server_select_function'){
                    addMessage("智链希望调用以下MCP服务器的功能,请你选择要执行的功能","ai")
                    addMessage("","ai_end")
                    GPTFunctions = data["select_functions"]
                    renderSelectFunction(data.select_functions)

                }
            };

            socket.onerror  = function(error) {
                console.error(' 连接异常：', error);
            };

            socket.onclose  = function(event) {
                console.log(` 连接关闭，代码：${event.code} ，原因：${event.reason}`);
            };

        }

        async function RequestQuestion(question,mcp_servers){
            // 添加用户消息
            addMessage(searchInput.value,  'user');
            searchInput.value  = '';
            userQuestion = question;

            let message = JSON.stringify(
                {
                    "type": "user_question",
                    "question": question,
                    "mcp_servers": mcp_servers
                }
            )

            console.log(message)

            socket.send(message)
        }

        async function GETServerFunction(server_url) {
            try{
                const response = await fetch(server_url, {
                    method: 'GET',
                    headers: {'Content-Type': 'application/json'}
                });
                return await response.json();
            } catch (error) {
                console.error(error);
            }
        }

        function isValidHttpUrl(str) {
            // 第一步：基础类型检查
            if (typeof str !== 'string') return false;

            // 第二步：协议前缀验证
            const protocolPattern = /^https?:\/\//i;
            if (!protocolPattern.test(str)) return false;

            // 第三步：完整URL结构验证
            try {
                const url = new URL(str);
                return ['http:', 'https:'].includes(url.protocol);
            } catch (_) {
                return false;
            }
        }

        async function addServer() {
            const input = document.getElementById('serverUrl');
            if(input.value&&isValidHttpUrl(input.value))  {
                let serverUrl = input.value;
                try{
                     await GETServerFunction(serverUrl+"/tools").then(res => {
                        serverList.push({
                            server_name: res?.server_name,
                            server_address: serverUrl,
                            server_functions: res["available_functions"] // 实际应用中应从服务器获取方法列表
                        });
                    })
                }catch (error) {
                    console.error(error);
                }
                renderServerList();
                input.value  = '';
            }
        }

        function addChat(chatName) {
            chatHistoryList.push({
                title: chatName
            })
            renderChatHistoryList();
        }

        function renderChatHistoryList(){
            let chatHistorySet = [...new Set(chatHistoryList)]
            chatHistory.innerHTML = chatHistorySet.map((chat,index)=> `
                <div class="chat-item" id="history-${index}" onclick="">
                    ${chat?.title}
                </div>
            `).join('');
        }

        function renderServerList() {
            const container = document.getElementById('MCP-server-list');
            container.innerHTML  = serverList.map((server, index) => `
                <div class="MCP-control" onclick="showMethods(${index})">
                    <div style="display: flex; justify-content: space-between">
                        <span>${server.server_name}</span>
                        <span style="color: #666">${server.server_functions.length}  个方法</span>
                    </div>
                    <div id="methods-${index}" style="display: none; margin-top: 8px; padding-left: 16px">
                        ${server.server_functions.length  ? server.server_functions.map(m  => `
                            <div style="color: #666; font-size: 0.9em">
                                ${m.function.name}(${Object.keys(m.function.parameters.properties).join(',  ')})
                            </div>
                        `).join('') : '暂未获取方法列表'}
                    </div>
                </div>
            `).join('');
        }

        function showMethods(index) {
            const methodsDiv = document.getElementById(`methods-${index}`);
            methodsDiv.style.display  = methodsDiv.style.display  === 'block' ? 'none' : 'block';
        }



        function initChatPanel(){
            document.body.classList.add('chat-active');
            searchContainer["style"].background = "black"
            searchContainer["style"].borderRadius = "30px"
            ChatContainer.style.display  = 'block';
            if (document.body.classList.contains('chat-active')) {
                translateHistoryPanel(0)
                fixedHistoryPanel()
            }
        }

        function undoChat(){
            document.body.classList.remove('chat-active');
            searchContainer["style"].background = ""
            searchContainer["style"].borderRadius = "0px"
            ChatContainer.style.display  = 'none';
            if (document.body.classList.contains('chat-active')) {
                translateHistoryPanel(0)
                unfixedHistoryPanel()
            }
        }


        // 设置背景的模糊度
        function BlurBackground(px) {
            background["style"].filter  = `blur(${px}px)`;
        }

        function fixedHistoryPanel() {
            historyPanel.classList.add('fixed');
            fixPanelButton.textContent  = '松开面板';
        }

        function unfixedHistoryPanel() {
            historyPanel.classList.remove('fixed');
            fixPanelButton.textContent  = '固定面板';
        }

        // 切换历史记录面板的模式
        function changeHistoryPanelMode(){
            if (historyPanel.classList.contains('fixed'))  {
                unfixedHistoryPanel()
            } else {
                fixedHistoryPanel()
            }
        }

        function closePanel(){
            settingsPanel.classList.remove('active');
            overlay.classList.remove('active');
        }

        // 移动历史记录面板
        function translateHistoryPanel(percent){
            historyPanel.style.transform  = `translateX(${percent}%)`;
        }

        newChatButton.addEventListener('click',()=>{
            undoChat()
        })

        // 设置按钮
        settingsButton.addEventListener('click', () => {
            settingsPanel.classList.add('active');
            overlay.classList.add('active');
        })

       // 三种关闭设置面板的方式：
       // 1. 点击关闭按钮
       closeButton.addEventListener('click',  closePanel);

       // 2. 点击遮罩层
       overlay.addEventListener('click',  closePanel);

       // 3. 键盘ESC键
       document.addEventListener('keydown',  (e) => {
           if (e.key  === 'Escape') closePanel();
       });


        // 背景模糊效果
        searchInput.addEventListener('focus',  () => {
            BlurBackground(5);
        });

        searchInput.addEventListener('blur',  () => {
            BlurBackground(0);
        });

        function SearchQuestion(){
            if(searchInput.value.trim())  {
                if(ChatContainer.style.display  !== 'block') {
                    addChat(searchInput.value.trim())
                }
                initChatPanel()
                RequestQuestion(searchInput.value,serverList)
            }

        }


        // 搜索按钮点击事件
        searchButton.addEventListener('click',  () => {
            SearchQuestion()
        });

        // 回车键事件
        searchInput.addEventListener('keydown',  (e) => {
            if (e.key  === 'Enter') {
                SearchQuestion()
            }
        });

        // 历史聊天记录按钮悬浮事件
        historyButton.addEventListener('mouseover',  () => {
            translateHistoryPanel(0)
        });

        historyPanel.addEventListener('mouseleave',  () => {
            if (!historyPanel.classList.contains('fixed'))  {
                translateHistoryPanel(-100)
            }
        });

        // 固定面板按钮点击事件
        fixPanelButton.addEventListener('click',  () => {
            changeHistoryPanelMode();
        });

        function toggleSelection(checkbox) {
            const funcId = checkbox.value;
            checkbox.checked  ? selectedFunctions.add(funcId)  : selectedFunctions.delete(funcId);
        }

        function executeFunction(){
            let selected = GPTFunctions.filter((func)=>{
                const funcId = func.id;

                return selectedFunctions.has(funcId)
            })
            if (selected.length > 0) {
                const container = document.getElementById('chatContainer');
                container.lastElementChild.remove();
                container.lastElementChild.remove();


                let message = {
                    "type":"user_select_function",
                    "question": userQuestion,
                    "select_functions":selected,
                    "mcp_servers": serverList
                }
                socket.send(JSON.stringify(message))
            }
        }

        function renderSelectFunction(function_list){
            const container = document.getElementById('chatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className  = `message ai-message`;
            const functionList = document.createElement('div');
            functionList.className  = `function-list`;
            functionList.id  = `functionList`;
            functionList.innerHTML = function_list.map(func=>`
            <div class="function-item">
                <label>
                    <input type="checkbox" value="${func.id}"
                        data-params='${func.parameters}'
                        onchange="toggleSelection(this)">
                    <div class="function-detail">
                        <span class="function-name">${func.name}</span>
                        <div class="parameter-list">
                            ${renderParameters(JSON.parse(func.parameters))}
                        </div>
                    </div>
                </label>
            </div>`)
            const executeButton = document.createElement('div');
            executeButton.className  = `execute-button`;
            executeButton.id  = `executeButton`;
            let button = document.createElement('button')
            button.onclick = executeFunction;
            button.innerText = "执行选中函数"
            executeButton.appendChild(button)

            msgDiv.appendChild(functionList);
            msgDiv.appendChild(executeButton);
            container.appendChild(msgDiv);
        }

        function renderParameters(params) {
        return Object.entries(params).map(([key,  value]) => `
            <div class="parameter">
                <span class="param-key">${key}:</span>
                <span class="param-value">${value}</span>
            </div>`).join('');
        }

        function addMessage(text, type) {

            const container = document.getElementById('chatContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className  = `message ${type}-message`;

            // 消息内容
            const content = document.createElement('div');
            content.className  = 'content';


            // 状态指示器
            const statusDiv = document.createElement('div');
            statusDiv.className  = `status-indicator ${type}-status-indicator`;
            statusDiv.innerHTML  = `
              <span class="loading"></span>
              <span class="sent">✓</span>
              <span class="read">✓✓</span>
            `;



            if(type === 'user'){
                content.textContent  = text;
                container.appendChild(msgDiv);
            }else if(type === 'ai'){
                let ai_content = container.lastElementChild
                if(ai_content.classList.contains('ai-message')){
                    ai_content.firstElementChild.textContent += text;
                }else {
                    content.textContent  = text;
                    container.appendChild(msgDiv);
                }
            }
            msgDiv.append(content,  statusDiv);

            // 初始状态设置
            msgDiv.classList.add('sending');

            // 模拟状态更新 (实际应结合API响应)
            if(type === 'user') {
              setTimeout(() => msgDiv.classList.replace('sending',  'sent'), 2000);
              setTimeout(() => msgDiv.classList.replace('sent',  'read'), 4000);
            }
            if(type === 'ai_end'){
                let ai_content = container.lastElementChild
                if(ai_content.classList.contains('sending')){
                    ai_content.classList.replace('sending',  'sent')
                }
            }
        }
    </script>
</body>

</html>